{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/forms.css' %}">
<style>
    .backup-dashboard {
        padding: 20px;
    }
    .backup-actions {
        margin-bottom: 20px;
    }
    .backup-list {
        width: 100%;
        border-collapse: collapse;
    }
    .backup-list th, .backup-list td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
    }
    .backup-list th {
        background-color: #f5f5f5;
    }
    .status-pending { color: #f0ad4e; }
    .status-in-progress { color: #5bc0de; }
    .status-completed { color: #5cb85c; }
    .status-failed { color: #d9534f; }
    .error-message {
        color: #d9534f;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="backup-dashboard">
    <h1>Database Backup Dashboard</h1>
    
    <div class="backup-actions">
        <button id="create-backup" class="button">Create New Backup</button>
        <button id="refresh-status" class="button">Refresh Status</button>
    </div>

    <table class="backup-list">
        <thead>
            <tr>
                <th>Filename</th>
                <th>Status</th>
                <th>Started At</th>
                <th>Completed At</th>
                <th>Duration</th>
                <th>File Size</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="backup-list-body">
            <!-- Backup list will be populated by JavaScript -->
        </tbody>
    </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const createBackupBtn = document.getElementById('create-backup');
    const refreshStatusBtn = document.getElementById('refresh-status');
    const backupListBody = document.getElementById('backup-list-body');

    function updateBackupList() {
        fetch('{% url "suppliers:backup_status" %}')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    backupListBody.innerHTML = data.backups.map(backup => `
                        <tr>
                            <td>${backup.filename}</td>
                            <td class="status-${backup.status}">${backup.status}</td>
                            <td>${new Date(backup.started_at).toLocaleString()}</td>
                            <td>${backup.completed_at ? new Date(backup.completed_at).toLocaleString() : '-'}</td>
                            <td>${backup.duration || '-'}</td>
                            <td>${backup.file_size}</td>
                            <td>
                                ${backup.status === 'completed' ? 
                                    `<a href="{% url "suppliers:download_backup" 0 %}".replace('0', backup.id) 
                                        class="button">Download</a>` : 
                                    ''}
                                ${backup.error_message ? 
                                    `<div class="error-message">${backup.error_message}</div>` : 
                                    ''}
                            </td>
                        </tr>
                    `).join('');
                }
            })
            .catch(error => console.error('Error fetching backup status:', error));
    }

    createBackupBtn.addEventListener('click', function() {
        fetch('{% url "suppliers:create_backup" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Backup started successfully');
                updateBackupList();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error creating backup:', error);
            alert('Error creating backup');
        });
    });

    refreshStatusBtn.addEventListener('click', updateBackupList);

    // Initial load
    updateBackupList();
});
</script>
{% endblock %} 