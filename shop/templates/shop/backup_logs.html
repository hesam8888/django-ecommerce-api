{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<style>
    .backup-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    .backup-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        padding: 20px;
    }
    .backup-section h2 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .stat-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2d3436;
        margin: 10px 0;
    }
    .stat-label {
        color: #636e72;
        font-size: 0.9em;
    }
    .progress-bar {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        margin-top: 10px;
    }
    .progress-fill {
        height: 100%;
        background: #0984e3;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    .log-container {
        background: #f8f9fa;
        border-radius: 4px;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
        font-family: monospace;
    }
    .log-line {
        margin: 2px 0;
        padding: 2px 5px;
        border-radius: 3px;
    }
    .log-line.error {
        background-color: #ffe6e6;
        color: #d63031;
    }
    .backup-files {
        display: grid;
        gap: 10px;
    }
    .backup-file {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #eee;
    }
    .backup-file:hover {
        background: #f1f3f5;
    }
    .backup-info {
        flex-grow: 1;
    }
    .backup-name {
        font-weight: bold;
        color: #2d3436;
    }
    .backup-meta {
        color: #636e72;
        font-size: 0.9em;
        margin-top: 5px;
    }
    .backup-actions {
        display: flex;
        gap: 10px;
    }
    .btn {
        padding: 8px 15px;
        border-radius: 4px;
        text-decoration: none;
        transition: background 0.3s;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }
    .btn-primary {
        background: #0984e3;
        color: white;
    }
    .btn-primary:hover {
        background: #0873c4;
    }
    .btn-danger {
        background: #d63031;
        color: white;
    }
    .btn-danger:hover {
        background: #c23616;
    }
    .btn-success {
        background: #00b894;
        color: white;
    }
    .btn-success:hover {
        background: #00a884;
    }
    .auto-refresh {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }
    .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }
    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    input:checked + .slider {
        background-color: #2196F3;
    }
    input:checked + .slider:before {
        transform: translateX(26px);
    }
</style>
{% endblock %}

{% block content %}
<div class="backup-container">
    <div class="auto-refresh">
        <label class="switch">
            <input type="checkbox" id="autoRefresh" checked>
            <span class="slider"></span>
        </label>
        <span>Auto-refresh (every 30 seconds)</span>
        <form method="post" action="{% url 'trigger_backup' %}" style="margin-left: auto;">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">ðŸ”„ Trigger Backup Now</button>
        </form>
    </div>

    <div class="backup-section">
        <h2>System Statistics</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Disk Usage</div>
                <div class="stat-value">{{ system_stats.disk_percent }}%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ system_stats.disk_percent }}%"></div>
                </div>
                <div class="stat-label">
                    {{ system_stats.disk_used }} of {{ system_stats.disk_total }}
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Backups</div>
                <div class="stat-value">{{ system_stats.backup_count }}</div>
                <div class="stat-label">Total Size: {{ system_stats.total_backup_size }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Successful Backups</div>
                <div class="stat-value">{{ backup_stats.success_count }}</div>
                <div class="stat-label">Last: {{ backup_stats.last_success }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Failed Backups</div>
                <div class="stat-value">{{ backup_stats.error_count }}</div>
                <div class="stat-label">Last: {{ backup_stats.last_error }}</div>
            </div>
        </div>
    </div>

    <div class="backup-section">
        <h2>Recent Backup Logs</h2>
        <div class="log-container" id="logContainer">
            {% for log in logs %}
                <div class="log-line {% if 'ERROR' in log %}error{% endif %}">
                    {{ log }}
                </div>
            {% empty %}
                <div class="log-line">No logs available</div>
            {% endfor %}
        </div>
    </div>

    <div class="backup-section">
        <h2>Available Backups</h2>
        <div class="backup-files" id="backupFiles">
            {% for backup in backup_files %}
                <div class="backup-file">
                    <div class="backup-info">
                        <div class="backup-name">{{ backup.name }}</div>
                        <div class="backup-meta">
                            Size: {{ backup.size_human }} | Created: {{ backup.date }}
                            {% if backup.age_days > 6 %}
                                <span style="color: #d63031;">(Will be deleted soon)</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="backup-actions">
                        <a href="{% url 'download_backup' backup.name %}" class="btn btn-primary">
                            Download
                        </a>
                        <form method="post" action="{% url 'delete_backup' backup.name %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this backup?')">
                                Delete
                            </button>
                        </form>
                    </div>
                </div>
            {% empty %}
                <div class="backup-file">
                    <div class="backup-info">No backup files available</div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
let autoRefreshInterval;
const logContainer = document.getElementById('logContainer');
const backupFiles = document.getElementById('backupFiles');
const autoRefreshCheckbox = document.getElementById('autoRefresh');

function updateContent() {
    fetch('{% url "backup_status" %}')
        .then(response => response.json())
        .then(data => {
            // Update logs
            logContainer.innerHTML = data.logs.map(log => 
                `<div class="log-line ${log.includes('ERROR') ? 'error' : ''}">${log}</div>`
            ).join('');
            
            // Update backup files
            backupFiles.innerHTML = data.backup_files.map(backup => `
                <div class="backup-file">
                    <div class="backup-info">
                        <div class="backup-name">${backup.name}</div>
                        <div class="backup-meta">
                            Size: ${backup.size} | Created: ${backup.date}
                        </div>
                    </div>
                    <div class="backup-actions">
                        <a href="{% url 'download_backup' '${backup.name}' %}" class="btn btn-primary">
                            Download
                        </a>
                        <form method="post" action="{% url 'delete_backup' '${backup.name}' %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this backup?')">
                                Delete
                            </button>
                        </form>
                    </div>
                </div>
            `).join('');
        })
        .catch(error => console.error('Error updating content:', error));
}

function toggleAutoRefresh() {
    if (autoRefreshCheckbox.checked) {
        autoRefreshInterval = setInterval(updateContent, 30000);
    } else {
        clearInterval(autoRefreshInterval);
    }
}

autoRefreshCheckbox.addEventListener('change', toggleAutoRefresh);
toggleAutoRefresh(); // Start auto-refresh if checked
</script>
{% endblock %} 