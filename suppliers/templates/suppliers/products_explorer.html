{% extends "suppliers/base.html" %}
{% load static i18n %}

{% block title %}{% trans "All Products" %} | {% trans "Supplier Dashboard" %}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #4a6fa5;
        --primary-light: #eef2f7;
        --accent-color: #e7c9a9;
        --text-color: #2d3748;
        --text-light: #718096;
        --bg-color: #f8f9fa;
        --white: #ffffff;
        --gray-100: #f7fafc;
        --gray-200: #edf2f7;
        --gray-300: #e2e8f0;
        --gray-400: #cbd5e0;
        --gray-500: #a0aec0;
        --status-active: #68d391;
        --status-draft: #f6ad55;
        --status-inactive: #fc8181;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --radius-sm: 0.25rem;
        --radius: 0.375rem;
        --radius-md: 0.5rem;
        --transition: all 0.3s ease;
        --product-card-scale: 1;
    }

    .explorer-container {
        background-color: var(--bg-color);
        min-height: calc(100vh - 60px);
        padding: 2rem;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .actions-container {
        display: flex;
        gap: 1rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: var(--radius);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        border: none;
    }

    .btn-primary {
        background-color: var(--primary-color);
        color: var(--white);
    }

    .btn-primary:hover {
        background-color: #3d5d8a;
    }

    .btn-outline {
        background-color: transparent;
        border: 1px solid var(--gray-300);
    }

    .btn-outline:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        background-color: var(--white);
        padding: 1rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
    }

    .search-container {
        flex: 1;
        min-width: 250px;
    }

    .search-box {
        width: 100%;
        padding: 0.625rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius);
        font-size: 0.875rem;
        color: var(--text-color);
        transition: var(--transition);
    }

    .search-box:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
    }

    .filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .filter-select {
        padding: 0.625rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius);
        font-size: 0.875rem;
        background-color: var(--white);
        min-width: 150px;
        color: var(--text-color);
        transition: var(--transition);
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .view-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: auto;
    }

    .view-btn {
        padding: 0.5rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-sm);
        background-color: var(--white);
        cursor: pointer;
        transition: var(--transition);
    }

    .view-btn.active {
        background-color: var(--primary-light);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .view-btn:hover:not(.active) {
        border-color: var(--gray-400);
    }

    .product-grid {
        display: none;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .product-grid.active {
        display: grid;
    }

    .product-card {
        background-color: var(--white);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: var(--transition);
        position: relative;
        transform: scale(var(--product-card-scale));
        transform-origin: top left;
        width: calc(100% / var(--product-card-scale));
        margin-bottom: 0.5rem;
        height: fit-content;
        cursor: pointer; /* Make it clear the card is clickable */
    }

    .product-card:hover {
        box-shadow: var(--shadow-md);
        transform: scale(var(--product-card-scale)) translateY(-2px);
    }
    
    /* Make it clear that cards are clickable */
    .product-card:not(:hover) {
        cursor: pointer;
    }
    
    .product-card:hover {
        cursor: pointer;
    }

    .card-checkbox {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        z-index: 10;
        opacity: 0;
        transition: var(--transition);
    }

    .product-card:hover .card-checkbox {
        opacity: 1;
    }

    .product-image {
        position: relative;
        padding-top: 75%; /* 4:3 Aspect Ratio */
        background-color: var(--gray-100);
        overflow: hidden;
    }

    .product-image img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain; /* Changed from cover to contain to preserve aspect ratio */
        transition: var(--transition);
        max-height: 200px; /* Control the max height */
    }

    .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        opacity: 0;
        transition: var(--transition);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .product-card:hover .image-overlay {
        opacity: 1;
    }

    .quick-view-btn {
        background-color: var(--white);
        color: var(--text-color);
        padding: 0.5rem 1rem;
        border-radius: var(--radius);
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
    }

    .quick-view-btn:hover {
        background-color: var(--primary-color);
        color: var(--white);
    }

    .status-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        font-size: 0.6875rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    .status-active {
        background-color: var(--status-active);
        color: #22543d;
    }

    .status-draft {
        background-color: var(--status-draft);
        color: #7b341e;
    }

    .status-inactive {
        background-color: var(--status-inactive);
        color: #822727;
    }

    .product-info {
        padding: 1rem;
    }

    .product-name {
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-color);
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        height: 2.75rem;
    }

    .product-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .product-price {
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .product-brand {
        font-size: 0.875rem;
        color: var(--text-light);
    }

    .product-category {
        font-size: 0.75rem;
        color: var(--text-light);
        background-color: var(--gray-100);
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        display: inline-block;
    }

    .product-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--gray-200);
    }

    .action-btn {
        background: none;
        border: none;
        color: var(--text-light);
        font-size: 0.875rem;
        cursor: pointer;
        transition: var(--transition);
    }

    .action-btn:hover {
        color: var(--primary-color);
    }

    .batch-actions {
        display: none;
        padding: 1rem;
        background-color: var(--white);
        border-radius: var(--radius);
        box-shadow: var(--shadow-md);
        margin-bottom: 1rem;
        align-items: center;
    }

    .batch-actions.active {
        display: flex;
    }

    .batch-actions-label {
        margin-right: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .batch-action-btns {
        display: flex;
        gap: 0.5rem;
    }

    .product-list {
        display: none;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .product-list.active {
        display: flex;
    }

    .product-list-item {
        display: flex;
        background-color: var(--white);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        transform: scale(var(--product-card-scale));
        transform-origin: top left;
        width: calc(100% / var(--product-card-scale));
        margin-bottom: calc(10px * var(--product-card-scale));
        height: fit-content;
    }

    .list-image {
        width: 120px;
        height: 120px;
        object-fit: contain; /* Changed from cover to contain */
        transition: var(--transition);
    }

    .list-info {
        flex: 1;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .list-header {
        display: flex;
        justify-content: space-between;
    }

    .list-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
        gap: 0.5rem;
    }

    .page-item {
        min-width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius);
        font-size: 0.875rem;
        border: 1px solid var(--gray-300);
        cursor: pointer;
        transition: var(--transition);
    }

    .page-item.active {
        background-color: var(--primary-color);
        color: var(--white);
        border-color: var(--primary-color);
    }

    .page-item:hover:not(.active) {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .no-results {
        text-align: center;
        padding: 2rem;
        background-color: var(--white);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
    }

    .no-results-icon {
        font-size: 3rem;
        color: var(--gray-400);
        margin-bottom: 1rem;
    }

    .no-results-text {
        font-size: 1.125rem;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .no-results-subtext {
        font-size: 0.875rem;
        color: var(--text-light);
        margin-bottom: 1.5rem;
    }

    @media (max-width: 768px) {
        .explorer-container {
            padding: 1rem;
        }

        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .actions-container {
            width: 100%;
        }

        .toolbar {
            flex-direction: column;
        }

        .view-controls {
            margin-left: 0;
            margin-top: 1rem;
        }

        .product-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }

        .product-list-item {
            flex-direction: column;
        }

        .list-image {
            width: 100%;
            height: 150px;
        }
    }

    /* Remove Quick Edit related styles */
    .quick-view-btn,
    .image-overlay {
        display: none !important;
    }

    /* Ensure images are not clickable */
    .product-image img {
        pointer-events: none !important;
    }

    /* Remove hover effects */
    .product-image:hover::after,
    .product-image:hover::before {
        display: none !important;
    }

    /* Custom image controls */
    .image-size-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 5px;
        z-index: 5;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 3px;
        border-radius: var(--radius-sm);
        opacity: 0;
        transition: var(--transition);
        pointer-events: none; /* Allow clicks to pass through the container */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .product-card:hover .image-size-controls,
    .product-list-item:hover .image-size-controls {
        opacity: 1;
        pointer-events: auto; /* Enable pointer events when visible */
    }
    
    .image-size-btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        pointer-events: auto; /* Ensure buttons are always clickable when parent allows it */
        transition: var(--transition);
    }
    
    .image-size-btn:hover {
        background-color: #3d5d8a;
        transform: scale(1.1);
    }


    /* Update toolbar to rename the labels */
    .global-image-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 20px;
        background-color: var(--primary-light);
        padding: 5px 10px;
        border-radius: var(--radius);
    }

    /* Remove sidebar styles */
    .product-detail-sidebar {
        display: none !important;
    }

    /* Modal styles */
    .product-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
        padding: 2rem 1rem;
    }

    .product-modal.active {
        display: flex;
    }

    .product-modal .modal-content {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: var(--radius);
        padding: 2rem;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        margin: auto;
        transform: translateY(0);
        overflow-y: auto;
    }

    .product-modal .modal-content::-webkit-scrollbar {
        width: 8px;
    }

    .product-modal .modal-content::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }

    .product-modal .modal-content::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
    }

    .product-modal .modal-content::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
    }

    .product-modal .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        position: sticky;
        top: 0;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        z-index: 1;
    }

    .product-modal .modal-header h3 {
        color: var(--text-color);
        margin: 0;
        font-size: 1.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .product-modal .modal-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 1.5rem;
    }

    .product-modal .modal-image-container {
        position: relative;
        width: 100%;
        height: 300px;
        border-radius: var(--radius);
        overflow: hidden;
        background: rgba(0, 0, 0, 0.05);
    }

    .product-modal .modal-image-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        transition: transform 0.3s ease;
    }

    .product-modal .modal-info {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .product-modal .info-section {
        background: rgba(255, 255, 255, 0.5);
        padding: 1rem;
        border-radius: var(--radius);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .product-modal .info-section h3 {
        color: var(--text-color);
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .product-modal .info-section p {
        color: var(--text-color);
        margin: 0;
        font-size: 0.9rem;
    }

    .product-modal .product-attributes {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .product-modal .attribute-item {
        background: rgba(255, 255, 255, 0.5);
        padding: 0.75rem;
        border-radius: var(--radius);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .product-modal .attribute-label {
        color: var(--text-light);
        font-size: 0.8rem;
        display: block;
        margin-bottom: 0.25rem;
    }

    .product-modal .attribute-value {
        color: var(--text-color);
        font-size: 0.9rem;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .product-modal {
            padding: 1rem;
        }

        .product-modal .modal-content {
            padding: 1.5rem;
            max-height: 95vh;
        }

        .product-modal .modal-body {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
    }

    .warning {
        background: rgba(231, 76, 60, 0.1);
        border: 1px solid rgba(231, 76, 60, 0.2);
        color: var(--danger-color);
        padding: 1rem;
        border-radius: var(--radius);
        margin: 1rem 0;
        text-align: center;
        backdrop-filter: blur(5px);
    }

    .product-info {
        background: rgba(0, 0, 0, 0.05);
        padding: 1rem;
        border-radius: var(--radius);
        margin: 1rem 0;
        backdrop-filter: blur(5px);
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-row:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .info-label {
        color: var(--text-secondary);
    }

    .info-value {
        color: var(--text-color);
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="explorer-container">
    {% csrf_token %}
    
    <!-- Messages Display -->
    {% if messages %}
        <div class="messages-container" style="margin-bottom: 1rem;">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}" style="padding: 0.75rem; margin-bottom: 0.5rem; border-radius: var(--radius); 
                     {% if message.tags == 'success' %}background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724;
                     {% elif message.tags == 'error' %}background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24;
                     {% elif message.tags == 'warning' %}background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404;
                     {% else %}background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460;{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
    <div class="page-header">
        <div>
            <h1 class="page-title">
                {% if is_admin %}
                {% trans "All Products (Admin View)" %}
                {% else %}
                {% trans "All Products" %}
                {% endif %}
            </h1>
            <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 0.5rem;">
                📦 {{ total_products }} {% trans "total products" %} | 
                🌟 {{ new_arrivals_count }} {% trans "new arrivals" %} |
                ✅ {{ active_new_arrivals }} {% trans "active new arrivals" %}
                
                {% if selected_new_arrivals == 'yes' %}
                <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 10px;">
                    🌟 {% trans "Showing New Arrivals Only" %}
                </span>
                {% endif %}
            </div>
        </div>
        <div class="actions-container">
            {% if is_admin %}
            <a href="{% url 'admin:shop_product_changelist' %}" class="btn btn-outline">
                <i class="fa fa-arrow-left"></i> {% trans "Back to Admin" %}
            </a>
            {% else %}
            {% if user.is_staff %}
            <a href="{% url 'shop:admin_products_explorer' %}" class="btn btn-outline">
                <i class="fa fa-shield"></i> {% trans "Admin View" %}
            </a>
            {% endif %}
            {% endif %}
            <button class="btn btn-outline" id="enable-selection-btn">{% trans "Enable Selection" %}</button>
            <button class="btn btn-outline" id="batch-delete-btn" style="display: none;">{% trans "Delete Selected" %}</button>
            <a href="{% url 'shop:new_arrivals' %}" class="btn btn-outline" target="_blank">
                <i class="fa fa-star"></i> {% trans "View New Arrivals Page" %}
            </a>
            <a href="{% if request.user.is_superuser %}{% url 'suppliers:select_supplier' %}{% else %}{% url 'suppliers:add_product' %}{% endif %}" class="btn btn-primary">{% trans "Add Product" %}</a>
        </div>
    </div>

    <div class="batch-actions" id="batch-actions">
        <span class="batch-actions-label"><span id="selected-count">0</span> {% trans "items selected" %}</span>
        <div class="batch-action-btns">
            <button class="btn btn-outline" id="batch-mark-new-arrivals" onclick="batchAction('mark_new_arrivals')">
                <i class="fa fa-star"></i> {% trans "Mark as New Arrivals" %}
            </button>
            <button class="btn btn-outline" id="batch-unmark-new-arrivals" onclick="batchAction('unmark_new_arrivals')">
                <i class="fa fa-star-half-alt"></i> {% trans "Remove New Arrival" %}
            </button>
            <button class="btn btn-outline" id="batch-toggle-active" onclick="batchAction('toggle_active')">
                <i class="fa fa-toggle-on"></i> {% trans "Toggle Active" %}
            </button>
            <button class="btn btn-outline" id="batch-delete-confirm">{% trans "Delete" %}</button>
            <button class="btn btn-outline" id="batch-cancel">{% trans "Cancel" %}</button>
        </div>
    </div>

    <div class="toolbar">
        <div class="search-container">
            <input type="text" class="search-box" id="product-search" placeholder="{% trans 'Search products...' %}">
        </div>
        <div class="filter-container">
            <select class="filter-select" id="category-filter">
                <option value="">{% trans "All Categories" %}</option>
                {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
            </select>
            {% if is_admin %}
            <select class="filter-select" id="supplier-filter">
                <option value="">{% trans "All Suppliers" %}</option>
                {% for supplier in suppliers %}
                <option value="{{ supplier.id }}">
                    {{ supplier.name }}
                </option>
                {% endfor %}
            </select>
            {% endif %}
            <select class="filter-select" id="brand-filter">
                <option value="">{% trans "All Brands" %}</option>
                {% for brand in brands %}
                <option value="{{ brand }}">{{ brand }}</option>
                {% endfor %}
            </select>
            <select class="filter-select" id="status-filter">
                <option value="">{% trans "All Status" %}</option>
                <option value="active">{% trans "Active" %}</option>
                <option value="draft">{% trans "Draft" %}</option>
                <option value="inactive">{% trans "Inactive" %}</option>
            </select>
            <select class="filter-select" id="new-arrivals-filter">
                <option value="">{% trans "All Products" %}</option>
                <option value="yes" {% if selected_new_arrivals == 'yes' %}selected{% endif %}>🌟 {% trans "New Arrivals Only" %}</option>
                <option value="no" {% if selected_new_arrivals == 'no' %}selected{% endif %}>{% trans "Regular Products" %}</option>
            </select>
            <select class="filter-select" id="sort-filter">
                <option value="created_desc">{% trans "Newest First" %}</option>
                <option value="created_asc">{% trans "Oldest First" %}</option>
                <option value="name_asc">{% trans "Name (A-Z)" %}</option>
                <option value="name_desc">{% trans "Name (Z-A)" %}</option>
                <option value="price_asc">{% trans "Price (Low to High)" %}</option>
                <option value="price_desc">{% trans "Price (High to Low)" %}</option>
            </select>
        </div>
        <div class="view-controls">
            <button class="view-btn active" id="grid-view-btn">
                <i class="fa fa-th"></i>
            </button>
            <button class="view-btn" id="list-view-btn">
                <i class="fa fa-list"></i>
            </button>
        </div>
        
        <!-- Global image size controls -->
        <div class="global-image-controls" style="display: flex; align-items: center; gap: 10px; margin-left: 20px;">
            <span style="font-size: 0.875rem;">{% trans "Product Size:" %}</span>
            <button id="zoom-out-all" class="btn btn-outline" style="padding: 3px 8px;">-</button>
            <button id="zoom-in-all" class="btn btn-outline" style="padding: 3px 8px;">+</button>
            <button id="reset-zoom" class="btn btn-outline" style="padding: 3px 8px;">{% trans "Reset" %}</button>
        </div>
    </div>

    {% if is_admin %}
    <div class="supplier-filter-bar" style="background-color: #4a6fa5; color: white; padding: 1rem; margin-bottom: 2rem; border-radius: var(--radius); display: flex; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div style="font-weight: bold; min-width: 150px;">{% trans "Filter by Supplier:" %}</div>
        <form method="get" action="" style="display: flex; gap: 1rem; flex: 1; align-items: center;">
            <select name="supplier" class="filter-select" style="background-color: white; min-width: 250px; flex: 1;">
                <option value="">{% trans "All Suppliers" %}</option>
                {% for supplier in suppliers %}
                <option value="{{ supplier.id }}" 
                        {% if selected_supplier == supplier.id|stringformat:"i" %}selected{% endif %}>
                    {{ supplier.name }}
                </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn" style="background-color: white; color: #4a6fa5; font-weight: bold;">
                {% trans "Apply Filter" %}
            </button>
            {% if selected_supplier %}
            <a href="?{% for key, value in request.GET.items %}{% if key != 'supplier' and key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" 
               class="btn" style="background-color: rgba(255,255,255,0.2); color: white;">
                {% trans "Clear Supplier Filter" %}
            </a>
            {% endif %}
            
            {% if search_query %}
            <input type="hidden" name="q" value="{{ search_query }}">
            {% endif %}
            {% if selected_category %}
            <input type="hidden" name="category" value="{{ selected_category }}">
            {% endif %}
            {% if selected_brand %}
            <input type="hidden" name="brand" value="{{ selected_brand }}">
            {% endif %}
            {% if selected_status %}
            <input type="hidden" name="status" value="{{ selected_status }}">
            {% endif %}
            {% if selected_sort %}
            <input type="hidden" name="sort" value="{{ selected_sort }}">
            {% endif %}
        </form>
    </div>
    {% endif %}

    <!-- Grid View -->
    <div class="product-grid active" id="product-grid">
        {% for product in products %}
        <div class="product-card" data-id="{{ product.id }}">
            <input type="checkbox" class="card-checkbox product-checkbox" data-id="{{ product.id }}">
            <div class="product-image">
                {% if product.images.exists %}
                <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" class="grid-image" data-id="{{ product.id }}">
                <div class="image-size-controls">
                    <button class="image-size-btn zoom-in" data-id="{{ product.id }}">+</button>
                    <button class="image-size-btn zoom-out" data-id="{{ product.id }}">-</button>
                </div>
                {% else %}
                <img src="{% static 'shop/images/no-image.png' %}" alt="No Image" class="grid-image" data-id="{{ product.id }}">
                {% endif %}
                <div class="status-badges" style="position: absolute; top: 0.5rem; right: 0.5rem; display: flex; flex-direction: column; gap: 0.25rem;">
                    <div class="status-badge {% if product.is_active %}status-active{% elif product.draft %}status-draft{% else %}status-inactive{% endif %}">
                        {% if product.is_active %}{% trans "Active" %}{% elif product.draft %}{% trans "Draft" %}{% else %}{% trans "Inactive" %}{% endif %}
                    </div>
                    {% if product.is_new_arrival %}
                    <div class="status-badge" style="background-color: #ffc107; color: #000; font-size: 0.7rem;">
                        🌟 {% trans "New" %}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="product-info">
                <h3 class="product-name">{{ product.name }}</h3>
                <div class="product-meta">
                    <div class="product-price">{{ product.price }} USD</div>
                    <div class="product-brand">{{ product.brand|default:"—" }}</div>
                </div>
                <div class="product-category">{{ product.category.name }}</div>
                {% if is_admin %}
                <div class="product-supplier" style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-light);">
                    <strong>{% trans "Supplier:" %}</strong> {{ product.supplier.name }}
                </div>
                {% endif %}
                <div class="product-actions">
                    <a href="{% url 'admin:shop_product_change' product.id %}" class="action-btn">{% trans "Edit" %}</a>
                    <button class="action-btn delete-btn" data-id="{{ product.id }}" data-name="{{ product.name }}" data-category="{{ product.category.name }}" data-price="{{ product.price }}">{% trans "Delete" %}</button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-results">
            <div class="no-results-icon">
                <i class="fa fa-box-open"></i>
            </div>
            <h3 class="no-results-text">{% trans "No products found" %}</h3>
            <p class="no-results-subtext">{% trans "Try adjusting your search or filter to find what you're looking for." %}</p>
            <a href="{% url 'admin:shop_product_add' %}" class="btn btn-primary">{% trans "Add Product" %}</a>
        </div>
        {% endfor %}
    </div>

    <!-- List View -->
    <div class="product-list" id="product-list">
        {% for product in products %}
        <div class="product-list-item" data-id="{{ product.id }}">
            <div class="list-image-container" style="position: relative; width: 120px;">
                <img src="{% if product.images.exists %}{{ product.images.first.image.url }}{% else %}{% static 'shop/images/no-image.png' %}{% endif %}" alt="{{ product.name }}" class="list-image" data-id="{{ product.id }}">
                <div class="image-size-controls">
                    <button class="image-size-btn zoom-in" data-id="{{ product.id }}">+</button>
                    <button class="image-size-btn zoom-out" data-id="{{ product.id }}">-</button>
                </div>
            </div>
            <div class="list-info">
                <div class="list-header">
                    <h3 class="product-name">{{ product.name }}</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <div class="status-badge {% if product.is_active %}status-active{% elif product.draft %}status-draft{% else %}status-inactive{% endif %}">
                            {% if product.is_active %}{% trans "Active" %}{% elif product.draft %}{% trans "Draft" %}{% else %}{% trans "Inactive" %}{% endif %}
                        </div>
                        {% if product.is_new_arrival %}
                        <div class="status-badge" style="background-color: #ffc107; color: #000; font-size: 0.7rem;">
                            🌟 {% trans "New" %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="list-meta">
                    <div class="product-price">{{ product.price }} USD</div>
                    <div class="product-brand">{{ product.brand|default:"—" }}</div>
                    <div class="product-category">{{ product.category.name }}</div>
                    {% if is_admin %}
                    <div class="product-supplier">
                        <strong>{% trans "Supplier:" %}</strong> {{ product.supplier.name }}
                    </div>
                    {% endif %}
                </div>
                <div class="product-actions">
                    <a href="{% url 'admin:shop_product_change' product.id %}" class="action-btn">{% trans "Edit" %}</a>
                    <button class="action-btn delete-btn" data-id="{{ product.id }}" data-name="{{ product.name }}" data-category="{{ product.category.name }}" data-price="{{ product.price }}">{% trans "Delete" %}</button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-results">
            <div class="no-results-icon">
                <i class="fa fa-box-open"></i>
            </div>
            <h3 class="no-results-text">{% trans "No products found" %}</h3>
            <p class="no-results-subtext">{% trans "Try adjusting your search or filter to find what you're looking for." %}</p>
            <a href="{% url 'admin:shop_product_add' %}" class="btn btn-primary">{% trans "Add Product" %}</a>
        </div>
        {% endfor %}
    </div>

    {% if is_paginated %}
    <div class="pagination">
        {% if page_obj.has_previous %}
        <a href="?page=1" class="page-item">&laquo;</a>
        <a href="?page={{ page_obj.previous_page_number }}" class="page-item">&lsaquo;</a>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <a href="?page={{ num }}" class="page-item active">{{ num }}</a>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a href="?page={{ num }}" class="page-item">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="page-item">&rsaquo;</a>
        <a href="?page={{ page_obj.paginator.num_pages }}" class="page-item">&raquo;</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Replace the product modal HTML -->
<div class="product-modal" id="productModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalProductName"></h3>
            <button class="close-modal" id="closeModal">&times;</button>
        </div>
        <div class="modal-body" id="modalContent">
            <!-- Content will be dynamically populated -->
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>{% trans "Confirm Delete" %}</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <p>{% trans "Are you sure you want to delete this product?" %}</p>
            <div class="product-info">
                <h3 id="deleteProductName"></h3>
                <div class="info-row">
                    <span class="info-label">{% trans "Category:" %}</span>
                    <span class="info-value" id="deleteProductCategory"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">{% trans "Price:" %}</span>
                    <span class="info-value" id="deleteProductPrice"></span>
                </div>
            </div>
            <div class="warning">
                <p>{% trans "This action cannot be undone!" %}</p>
            </div>
        </div>
        <div class="modal-footer">
            <form id="deleteForm" method="post">
                {% csrf_token %}
                <input type="hidden" name="product_id" id="deleteProductId">
                <button type="button" class="btn-secondary close-modal">{% trans "Cancel" %}</button>
                <button type="submit" class="btn-danger">{% trans "Delete Product" %}</button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // View Toggle
    const gridViewBtn = document.getElementById('grid-view-btn');
    const listViewBtn = document.getElementById('list-view-btn');
    const productGrid = document.getElementById('product-grid');
    const productList = document.getElementById('product-list');

    function setGridView() {
        gridViewBtn.classList.add('active');
        listViewBtn.classList.remove('active');
        productGrid.classList.add('active');
        productList.classList.remove('active');
        localStorage.setItem('viewMode', 'grid');
    }

    function setListView() {
        listViewBtn.classList.add('active');
        gridViewBtn.classList.remove('active');
        productList.classList.add('active');
        productGrid.classList.remove('active');
        localStorage.setItem('viewMode', 'list');
    }

    gridViewBtn.addEventListener('click', setGridView);
    listViewBtn.addEventListener('click', setListView);

    // Restore view preference
    const savedViewMode = localStorage.getItem('viewMode');
    if (savedViewMode === 'list') {
        setListView();
    } else {
        setGridView();
    }

    // Selection mode state
    let selectionModeEnabled = false;
    const enableSelectionBtn = document.getElementById('enable-selection-btn');
    const batchDeleteBtn = document.getElementById('batch-delete-btn');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    const batchActions = document.getElementById('batch-actions');
    const selectedCount = document.getElementById('selected-count');
    const batchDeleteConfirm = document.getElementById('batch-delete-confirm');
    const batchCancel = document.getElementById('batch-cancel');

    let selectedProducts = new Set();

    // Initially hide all checkboxes
    productCheckboxes.forEach(checkbox => {
        checkbox.style.opacity = '0';
    });

    // Toggle selection mode
    enableSelectionBtn.addEventListener('click', function() {
        selectionModeEnabled = !selectionModeEnabled;
        
        if (selectionModeEnabled) {
            // Enable selection mode
            this.textContent = '{% trans "Disable Selection" %}';
            this.classList.add('active');
            batchDeleteBtn.style.display = 'inline-block';
            
            // Show all checkboxes
            productCheckboxes.forEach(checkbox => {
                checkbox.style.opacity = '1';
            });
        } else {
            // Disable selection mode
            this.textContent = '{% trans "Enable Selection" %}';
            this.classList.remove('active');
            batchActions.classList.remove('active');
            
            // Hide all checkboxes and clear selections
            productCheckboxes.forEach(checkbox => {
                checkbox.style.opacity = '0';
                checkbox.checked = false;
            });
            selectedProducts.clear();
            updateBatchActions();
        }
    });

    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (!selectionModeEnabled) return;
            
            const productId = this.dataset.id;
            
            if (this.checked) {
                selectedProducts.add(productId);
            } else {
                selectedProducts.delete(productId);
            }
            
            updateBatchActions();
        });
    });

    function updateBatchActions() {
        selectedCount.textContent = selectedProducts.size;
        
        if (selectedProducts.size > 0) {
            batchActions.classList.add('active');
        } else {
            batchActions.classList.remove('active');
        }
    }

    batchDeleteBtn.addEventListener('click', function() {
        if (!selectionModeEnabled) return;
        batchActions.classList.add('active');
    });

    batchDeleteConfirm.addEventListener('click', function() {
        if (selectedProducts.size > 0) {
            if (confirm(`{% trans "Are you sure you want to delete" %} ${selectedProducts.size} {% trans "products?" %}`)) {
                // Send delete request
                const productIds = Array.from(selectedProducts).join(',');
                {% if is_admin %}
                // For admin, post to a different endpoint
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{% url "admin:shop_product_changelist" %}';
                
                // Add CSRF token
                const csrfToken = document.createElement('input');
                csrfToken.type = 'hidden';
                csrfToken.name = 'csrfmiddlewaretoken';
                csrfToken.value = '{{ csrf_token }}';
                form.appendChild(csrfToken);
                
                // Add action
                const action = document.createElement('input');
                action.type = 'hidden';
                action.name = 'action';
                action.value = 'delete_selected';
                form.appendChild(action);
                
                // Add selected products
                productIds.split(',').forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = '_selected_action';
                    input.value = id;
                    form.appendChild(input);
                });
                
                document.body.appendChild(form);
                form.submit();
                {% else %}
                window.location.href = `{% url "suppliers:bulk_delete_products" %}?product_ids=${productIds}`;
                {% endif %}
            }
        }
    });

    batchCancel.addEventListener('click', function() {
        // Reset all checkboxes
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        selectedProducts.clear();
        updateBatchActions();
    });

    // Filters
    const searchBox = document.getElementById('product-search');
    const categoryFilter = document.getElementById('category-filter');
    const brandFilter = document.getElementById('brand-filter');
    const statusFilter = document.getElementById('status-filter');
    const sortFilter = document.getElementById('sort-filter');
    {% if is_admin %}
    const supplierFilter = document.getElementById('supplier-filter');
    {% endif %}

    // Apply filters function
    function applyFilters(e) {
        // If the event is from a checkbox, don't apply filters
        if (e && e.target && e.target.type === 'checkbox') {
            return;
        }

        const searchQuery = searchBox.value;
        const categoryId = categoryFilter.value;
        const brand = brandFilter.value;
        const status = statusFilter.value;
        const sort = sortFilter.value;
        {% if is_admin %}
        const supplierId = supplierFilter.value;
        {% endif %}

        let url = new URL(window.location.href);
        
        // Clear existing parameters
        url.search = '';
        
        // Add filter parameters
        if (searchQuery) url.searchParams.append('q', searchQuery);
        if (categoryId) url.searchParams.append('category', categoryId);
        if (brand) url.searchParams.append('brand', brand);
        if (status) url.searchParams.append('status', status);
        if (sort) url.searchParams.append('sort', sort);
        {% if is_admin %}
        if (supplierId) url.searchParams.append('supplier', supplierId);
        {% endif %}
        
        window.location.href = url.toString();
    }

    // Set up filter event listeners
    searchBox.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyFilters(e);
        }
    });

    [categoryFilter, brandFilter, statusFilter, sortFilter
    {% if is_admin %}, supplierFilter{% endif %}
    ].forEach(filter => {
        filter.addEventListener('change', applyFilters);
    });

    // Set initial filter values from URL
    const urlParams = new URLSearchParams(window.location.search);
    searchBox.value = urlParams.get('q') || '';
    categoryFilter.value = urlParams.get('category') || '';
    brandFilter.value = urlParams.get('brand') || '';
    statusFilter.value = urlParams.get('status') || '';
    sortFilter.value = urlParams.get('sort') || 'created_desc';
    {% if is_admin %}
    supplierFilter.value = urlParams.get('supplier') || '';
    {% endif %}

    // Remove any Quick Edit buttons that might be dynamically added
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.classList && (
                        node.classList.contains('quick-view-btn') ||
                        node.classList.contains('image-overlay')
                    )) {
                        node.remove();
                    }
                });
            }
        });
    });

    // Start observing the document with the configured parameters
    observer.observe(document.body, { childList: true, subtree: true });

    // Remove any existing Quick Edit buttons
    document.querySelectorAll('.quick-view-btn, .image-overlay').forEach(function(element) {
        element.remove();
    });

    // Make product cards and list items clickable
    document.querySelectorAll('.product-card, .product-list-item').forEach(item => {
        item.addEventListener('click', function(e) {
            // Don't trigger if clicking on action buttons, checkboxes, or image size controls
            if (e.target.closest('.action-btn') || 
                e.target.closest('.product-checkbox') || 
                e.target.closest('.image-size-controls') ||
                e.target.closest('input[type="checkbox"]')) {
                return;
            }
            
            const productId = this.getAttribute('data-id');
            if (productId) {
                showProductDetails(productId);
            }
        });
    });

    // Replace the showProductDetails function
    function showProductDetails(productId) {
        const modal = document.getElementById('productModal');
        const modalContent = document.getElementById('modalContent');
        const modalProductName = document.getElementById('modalProductName');
        
        // Show loading state
        modalContent.innerHTML = '<div class="loading">Loading...</div>';
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Fetch product details
        fetch(`/shop/product/${productId}/detail/`)
            .then(response => response.json())
            .then(product => {
                modalProductName.textContent = product.name;
                const content = `
                    <div class="modal-image-container">
                        ${product.image_url 
                            ? `<img src="${product.image_url}" alt="${product.name}">`
                            : `<div class="no-image">No image available</div>`
                        }
                    </div>
                    <div class="modal-info">
                        <div class="info-section">
                            <h3>{% trans "Price" %}</h3>
                            <p>${product.price} USD</p>
                        </div>
                        <div class="info-section">
                            <h3>{% trans "Category" %}</h3>
                            <p>${product.category}</p>
                        </div>
                        <div class="info-section">
                            <h3>{% trans "Supplier" %}</h3>
                            <p>${product.supplier || 'N/A'}</p>
                        </div>
                        <div class="info-section">
                            <h3>{% trans "Status" %}</h3>
                            <p>${product.is_active ? '{% trans "Active" %}' : '{% trans "Inactive" %}'}</p>
                        </div>
                        <div class="info-section">
                            <h3>{% trans "Created" %}</h3>
                            <p>${new Date(product.created_at).toLocaleDateString()}</p>
                        </div>
                        <div class="info-section">
                            <h3>{% trans "Description" %}</h3>
                            <p>${product.description || '{% trans "No description available" %}'}</p>
                        </div>
                        <div class="product-attributes">
                            <h3>{% trans "Attributes" %}</h3>
                            ${Object.keys(product.attributes || {}).length > 0 
                                ? Object.entries(product.attributes).map(([key, value]) => `
                                    <div class="attribute-item">
                                        <span class="attribute-label">${key}</span>
                                        <span class="attribute-value">${value}</span>
                                    </div>
                                `).join('')
                                : '<p>{% trans "No attributes defined" %}</p>'
                            }
                        </div>
                    </div>
                `;
                
                modalContent.innerHTML = content;
            })
            .catch(error => {
                console.error('Error fetching product details:', error);
                modalContent.innerHTML = '<div class="error">Error loading product details</div>';
            });
    }

    // Close modal when clicking close button
    document.getElementById('closeModal').addEventListener('click', function() {
        document.getElementById('productModal').classList.remove('active');
        document.body.style.overflow = '';
    });

    // Close modal when clicking outside
    document.getElementById('productModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
            document.body.style.overflow = '';
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('productModal').classList.contains('active')) {
            document.getElementById('productModal').classList.remove('active');
            document.body.style.overflow = '';
        }
    });

    // Individual image zoom functionality - update to handle whole card
    document.querySelectorAll('.zoom-in').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent triggering other click events
            const productId = this.getAttribute('data-id');
            scaleProductItem(productId, 0.1);
        });
    });
    
    document.querySelectorAll('.zoom-out').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent triggering other click events
            const productId = this.getAttribute('data-id');
            scaleProductItem(productId, -0.1);
        });
    });
    
    function scaleProductItem(productId, scaleChange) {
        // Find both grid and list items with this product ID
        const gridItem = document.querySelector(`.product-card[data-id="${productId}"]`);
        const listItem = document.querySelector(`.product-list-item[data-id="${productId}"]`);
        
        // Apply scaling to the found item (either grid or list, depending on view)
        const item = gridItem && gridItem.offsetParent !== null ? gridItem : listItem;
        
        if (item) {
            // Get current scale or default to 1
            let currentScale = parseFloat(item.style.transform?.match(/scale\(([^)]+)\)/)?.[1] || '1');
            
            // Apply scale change with limits
            currentScale = Math.max(0.5, Math.min(2.0, currentScale + scaleChange));
            
            // Apply new scale
            item.style.transform = `scale(${currentScale})`;
            item.style.transformOrigin = 'top left';
            item.style.width = `calc(100% / ${currentScale})`;
            
            // Add spacing for list items if scaled up
            if (item.classList.contains('product-list-item')) {
                item.style.marginBottom = `calc(20px * (${currentScale} - 1))`;
            }
        }
    }

    // Global image size controls
    const zoomInAllBtn = document.getElementById('zoom-in-all');
    const zoomOutAllBtn = document.getElementById('zoom-out-all');
    const resetZoomBtn = document.getElementById('reset-zoom');
    
    // Default scale
    const defaultScale = 1.0;
    
    // Current scale
    let currentScale = defaultScale;
    
    zoomInAllBtn.addEventListener('click', function() {
        // Increase scale by 0.1
        currentScale += 0.1;
        updateAllProductSizes();
    });
    
    zoomOutAllBtn.addEventListener('click', function() {
        // Decrease scale by 0.1 with minimum limit
        currentScale = Math.max(0.5, currentScale - 0.1);
        updateAllProductSizes();
    });
    
    resetZoomBtn.addEventListener('click', function() {
        // Reset to default scale
        currentScale = defaultScale;
        updateAllProductSizes();
    });
    
    function updateAllProductSizes() {
        // Update CSS variable for scaling
        document.documentElement.style.setProperty('--product-card-scale', currentScale);
        
        // Apply scaling classes
        document.querySelectorAll('.product-card, .product-list-item').forEach(item => {
            // Update transform
            item.style.transform = `scale(${currentScale})`;
            item.style.width = `calc(100% / ${currentScale})`;
            
            // Add spacing for list view if scaled up
            if (item.classList.contains('product-list-item')) {
                item.style.marginBottom = `calc(20px * (${currentScale} - 1))`;
            }
        });
        
        // Add spacing between grid items if needed
        const productGrid = document.getElementById('product-grid');
        if (currentScale > 1) {
            productGrid.style.gap = `calc(1.5rem * ${currentScale})`;
        } else {
            productGrid.style.gap = '1.5rem';
        }
    }

    const deleteModal = document.getElementById('deleteModal');
    const deleteForm = document.getElementById('deleteForm');
    const deleteProductId = document.getElementById('deleteProductId');
    const deleteProductName = document.getElementById('deleteProductName');
    const deleteProductCategory = document.getElementById('deleteProductCategory');
    const deleteProductPrice = document.getElementById('deleteProductPrice');
    const closeButtons = document.querySelectorAll('.close-modal');

    // Show delete modal
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const productId = this.dataset.id;
            const productName = this.dataset.name;
            const productCategory = this.dataset.category;
            const productPrice = this.dataset.price;

            deleteProductId.value = productId;
            deleteProductName.textContent = productName;
            deleteProductCategory.textContent = productCategory;
            deleteProductPrice.textContent = productPrice + ' USD';

            deleteModal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        });
    });

    // Close modal
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            deleteModal.style.display = 'none';
            document.body.style.overflow = ''; // Restore scrolling
        });
    });

    // Close modal when clicking outside
    window.addEventListener('click', function(e) {
        if (e.target === deleteModal) {
            deleteModal.style.display = 'none';
            document.body.style.overflow = ''; // Restore scrolling
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && deleteModal.style.display === 'flex') {
            deleteModal.style.display = 'none';
            document.body.style.overflow = ''; // Restore scrolling
        }
    });

    // Handle form submission
    deleteForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const productId = deleteProductId.value;

        // Create a form to submit to the admin delete URL
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/shop/product/${productId}/delete/`;
        
        // Add CSRF token
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        form.appendChild(csrfToken);
        
        // Add post parameter
        const postInput = document.createElement('input');
        postInput.type = 'hidden';
        postInput.name = 'post';
        postInput.value = 'yes';
        form.appendChild(postInput);
        
        // Submit the form
        document.body.appendChild(form);
        form.submit();
    });

    // Handle new arrivals filter
    const newArrivalsFilter = document.getElementById('new-arrivals-filter');
    if (newArrivalsFilter) {
        newArrivalsFilter.addEventListener('change', function() {
            const url = new URL(window.location);
            if (this.value) {
                url.searchParams.set('new_arrivals', this.value);
            } else {
                url.searchParams.delete('new_arrivals');
            }
            url.searchParams.delete('page'); // Reset pagination
            window.location = url;
        });
    }

    // Batch actions for new arrivals
    window.batchAction = function(action) {
        const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('لطفاً حداقل یک محصول انتخاب کنید.');
            return;
        }

        const productIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);
        
        let confirmMessage = '';
        switch(action) {
            case 'mark_new_arrivals':
                confirmMessage = `آیا می‌خواهید ${productIds.length} محصول را به عنوان "محصول جدید" علامت‌گذاری کنید؟`;
                break;
            case 'unmark_new_arrivals':
                confirmMessage = `آیا می‌خواهید علامت "محصول جدید" را از ${productIds.length} محصول حذف کنید؟`;
                break;
            case 'toggle_active':
                confirmMessage = `آیا می‌خواهید وضعیت فعال/غیرفعال ${productIds.length} محصول را تغییر دهید؟`;
                break;
        }

        if (!confirm(confirmMessage)) {
            return;
        }

        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.style.display = 'none';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }
        
        // Add action
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = action;
        form.appendChild(actionInput);
        
        // Add product IDs
        productIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'product_ids';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    };
});
</script>
{% endblock %} 